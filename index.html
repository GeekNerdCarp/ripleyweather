<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Weather Check ‚Ä¢ Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  /* =========
   * THEME VARIABLES
   * Default = NWS (Blue/Red). Other themes override these on body.theme-*
   * ========= */
  :root{
    --navy:#003366;          /* primary header/nav blue */
    --royal:#1d4e89;         /* secondary royal blue */
    --accent:#C4002F;        /* red accent (sparingly) */
    --panel:#ffffff;         /* card background */
    --bg:#f3f6fb;            /* page background */
    --text:#0f172a;          /* near-black text */
    --muted:#5a6b82;         /* muted text */
    --link:#1d4e89;          /* links */
    --link-hover:#0c3a6b;
    --border:#d7dce6;        /* light border */
    --shadow:0 6px 18px rgba(0, 0, 0, .06);
    --chip-bg:#eaf1fb;
    --chip-text:#0c3a6b;
    --bar-top:#114b8f;       /* section bar gradient top */
    --bar-bot:#0f417b;       /* section bar gradient bottom */
  }

  /* Retro 90s Weather Channel */
  body.theme-retro{
    --navy:#003b6f; --royal:#005a8d; --accent:#ffcc00;
    --panel:#002242; --bg:linear-gradient(to bottom,#003b6f,#000b1f 70%);
    --text:#eaf5ff; --muted:#c6d6ea; --link:#8bd0ff; --link-hover:#bdf0ff;
    --border:#004c80; --shadow:0 10px 24px rgba(0,0,0,.35);
    --chip-bg:#00325d; --chip-text:#eaf5ff;
    --bar-top:#0077b8; --bar-bot:#005a8d;
  }

  /* Night Sky (dark) */
  body.theme-night{
    --navy:#0b1b36; --royal:#13315a; --accent:#e05e00;
    --panel:#0f203f; --bg:#060e20;
    --text:#e7f0ff; --muted:#9db2cc; --link:#8ec2ff; --link-hover:#cfe6ff;
    --border:#224272; --shadow:0 12px 28px rgba(0,25,60,.45);
    --chip-bg:#162e59; --chip-text:#e7f0ff;
    --bar-top:#173a73; --bar-bot:#112c56;
  }

  /* High Contrast (accessibility) */
  body.theme-contrast{
    --navy:#14213d; --royal:#1f2b50; --accent:#fca311;
    --panel:#ffffff; --bg:#f8fafc;
    --text:#0b0b0b; --muted:#525252; --link:#0b53bf; --link-hover:#073a86;
    --border:#0b53bf33; --shadow:0 4px 16px rgba(0,0,0,.1);
    --chip-bg:#0b53bf15; --chip-text:#0b53bf;
    --bar-top:#0b53bf; --bar-bot:#0a48a5;
  }

  /* =========
   * BASE LAYOUT / COMPONENTS ‚Äî all colors read from variables above
   * ========= */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    color:var(--text);
    background:var(--bg);
    display:flex; flex-direction:column; min-height:100vh;
  }

  /* Masthead */
  header.mast{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg, var(--navy), #022a56);
    color:#fff; padding:12px 16px; border-bottom:4px solid var(--accent);
  }
  .mast-inner{display:flex; align-items:center; justify-content:space-between; gap:16px; max-width:1200px; margin:0 auto}
  .brand{display:flex; align-items:center; gap:12px}
  .logo{
    width:36px; height:36px; border-radius:6px; display:grid; place-items:center;
    background:#0e3e78; color:#fff; font-weight:800; box-shadow:inset 0 0 0 2px rgba(255,255,255,.15);
  }
  .brand h1{margin:0; font-size:1.05rem; letter-spacing:.2px; font-weight:800}
  .brand small{opacity:.9; font-weight:600}

  .controls{display:flex; align-items:center; gap:10px; color:#e6eef9}
  .stamp{font-size:.9rem; opacity:.9}
  .btn{
    background:#ffffff; color:var(--navy);
    border:2px solid var(--accent); border-radius:999px; padding:6px 12px; font-weight:700;
    cursor:pointer; transition:all .15s ease;
  }
  body.theme-retro .btn{ background:#0e78c2; color:#fff; border:2px solid #77c3ff; }
  .btn:hover{background:#fff2f5; transform:translateY(-1px)}
  .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}

  .select{
    appearance:none; -webkit-appearance:none;
    padding:6px 28px 6px 10px; border:2px solid var(--accent); border-radius:999px;
    background:#fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="14" viewBox="0 0 20 14"><path fill="%23C4002F" d="M5 5l5 5 5-5z"/></svg>') no-repeat right 8px center/16px;
    color:var(--navy); font-weight:700; cursor:pointer;
  }
  body.theme-retro .select{
    background:#0e78c2 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="14" viewBox="0 0 20 14"><path fill="%23ffffff" d="M5 5l5 5 5-5z"/></svg>') no-repeat right 8px center/16px;
    color:#fff; border-color:#77c3ff;
  }

  /* Layout */
  .wrap{display:grid; grid-template-columns:260px 1fr; gap:18px; width:100%; max-width:1200px; margin:16px auto; padding:0 16px}
  @media (max-width: 1100px){ .wrap{grid-template-columns:1fr} nav.toc{position:relative; top:auto} }

  /* TOC / Navigation */
  nav.toc{
    position:sticky; top:76px; align-self:start;
    background:#0e2f5a; color:#eaf1fb; border:1px solid #0b294f; border-radius:10px; padding:10px;
    box-shadow:var(--shadow);
  }
  body.theme-retro nav.toc{ background:#001a33; border-color:#003b6f }
  body.theme-night nav.toc{ background:#0b1f3e; border-color:#173a73 }
  body.theme-contrast nav.toc{ background:#ffffff; border-color:#0b53bf33; color:#0b0b0b }

  .toc h3{margin:12px 8px 6px; font-size:.8rem; text-transform:uppercase; letter-spacing:.06em; color:#d8e6f7}
  body.theme-contrast .toc h3{ color:#0b53bf; }
  .toc a{
    display:block; margin:6px 6px; padding:8px 10px; border-radius:8px; text-decoration:none;
    color:#eaf1fb; background:#153d70; border:1px solid #0f325d;
  }
  .toc a:hover{background:#1b4b8a}
  body.theme-contrast .toc a{ color:#0b0b0b; background:#f7faff; border-color:#dfe8fb }
  body.theme-contrast .toc a:hover{ background:#eaf2ff }

  .toc .group{ margin:8px 0; border-left:3px solid var(--accent); padding-left:6px; }

  /* Cards / Sections */
  main.content{min-width:0}
  section.card{
    background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px 16px; margin-bottom:14px;
    box-shadow:var(--shadow);
  }
  body.theme-retro section.card{ background:var(--panel); border-color:#005d99 }
  body.theme-retro main.content h2{ color:#fffd74 }

  .bar{
    display:flex; align-items:center; gap:10px; margin:-14px -16px 12px; padding:10px 14px; border-radius:12px 12px 0 0;
    background:linear-gradient(180deg, var(--bar-top), var(--bar-bot)); color:#fff; border-bottom:3px solid var(--accent); font-weight:800; letter-spacing:.2px;
  }

  /* Tables & text */
  table{width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--border); border-radius:8px; overflow:hidden}
  thead th{background:#0f417b; color:#fff; padding:10px; text-align:left; font-weight:800; font-size:.92rem}
  body.theme-retro thead th{ background:#005a8d }
  body.theme-night thead th{ background:#173a73 }
  body.theme-contrast thead th{ background:#0b53bf }

  td{padding:10px; border-top:1px solid var(--border)}
  tr:nth-child(even) td{background:#f8fbff}
  body.theme-retro tr:nth-child(even) td{ background:#001e38 }

  .muted{color:var(--muted)}
  a{color:var(--link); text-decoration:none}
  a:hover{color:var(--link-hover); text-decoration:underline}

  /* Chips for small values */
  .chips{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 2px}
  .chip{background:var(--chip-bg); color:var(--chip-text); padding:4px 8px; border-radius:999px; border:1px solid #d1e3fb; font-size:.9rem; font-weight:700}

  /* Slightly larger spacing for Quick Look / Key Items */
  #quickHtml ul, #cardsHtml ul{display:grid; gap:8px; margin:0; padding-left:1.1rem}
  #quickHtml li, #cardsHtml li{line-height:1.5}

  footer{
    max-width:1200px; margin:24px auto 28px; padding:16px; color:var(--muted); font-size:.9rem;
    border-top:3px solid var(--accent)
  }
  footer ul{list-style:none; padding:0; margin:8px 0 0; line-height:1.6}
</style>
</head>

<body>
  <header class="mast">
    <div class="mast-inner">
      <div class="brand">
        <div class="logo">WX</div>
        <h1>Ripley Weather <small>‚Ä¢ Local Outlook</small></h1>
      </div>
      <div class="controls">
        <select id="themeSelect" class="select" title="Choose theme">
          <option value="nws">NWS (Blue/Red)</option>
          <option value="retro">Retro 90s</option>
          <option value="night">Night Sky</option>
          <option value="contrast">High Contrast</option>
        </select>
        <button id="refreshBtn" class="btn" title="Fetch fresh data">‚Üª Refresh</button>
        <div id="runStamp" class="stamp">Loading‚Ä¶</div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <nav class="toc">
      <div class="group">
        <h3>Forecast</h3>
        <a href="#quick">üîé Quick Look</a>
        <a href="#cards">üìã Key Cards</a>
        <a href="#afd">üìù AFD (External)</a>
        <a href="#seven">üìÜ 7-Day</a>
        <a href="#dayplanner">üïí 24-Hour Planner</a>
      </div>
      <div class="group">
        <h3>Storm Outlook</h3>
        <a href="#trends">üìà Trends & Diagnostics</a>
        <a href="#severe">‚õà Severe Weather</a>
        <a href="#radar">üõ∞ Radar & Satellite</a>
        <a href="#lightning">‚ö° Lightning</a>
      </div>
      <div class="group">
        <h3>Impacts</h3>
        <a href="#alerts">‚ö†Ô∏è Alerts</a>
        <a href="#health">üå¨ Air & Health</a>
        <a href="#local">üè´ Local Impacts</a>
        <a href="#rivers">üåä Rivers & Streams</a>
      </div>
      <div class="group">
        <h3>Climate & Sky</h3>
        <a href="#records">üìä Climatology</a>
        <a href="#astro">üåå Astronomy</a>
      </div>
      <div class="group">
        <h3>Summary</h3>
        <a href="#bottom">‚úÖ Bottom Line</a>
      </div>
    </nav>

    <main class="content">
      <h2 id="runTitle" style="margin:0 0 8px; font-size:1.35rem; color:var(--navy)">Ripley Weather</h2>

      <section id="quick" class="card">
        <div class="bar">üîé Quick Look</div>
        <div id="quickHtml">Loading‚Ä¶</div>
      </section>

      <section id="cards" class="card">
        <div class="bar">üìã Key Items</div>
        <div id="cardsHtml">Loading‚Ä¶</div>
      </section>

      <section id="afd" class="card">
        <div class="bar">üìù Area Forecast Discussion</div>
        <p class="muted">Full text hosted by weather.gov</p>
        <p><a id="afdLink" href="#" target="_blank" rel="noopener">Open NWS ILN AFD</a></p>
      </section>

      <section id="seven" class="card">
        <div class="bar">üìÜ 7-Day Outlook</div>
        <div id="sevenHtml">Loading‚Ä¶</div>
      </section>

      <section id="dayplanner" class="card">
        <div class="bar">üïí 24-Hour Planner</div>
        <div id="plannerHtml">Loading‚Ä¶</div>
      </section>

      <section id="trends" class="card">
        <div class="bar">üìà Trends & Diagnostics</div>
        <div id="trendsHtml">Loading‚Ä¶</div>
      </section>

      <section id="severe" class="card">
        <div class="bar">‚õà Severe Weather Diagnostics</div>
        <div id="severeHtml">Loading‚Ä¶</div>
      </section>

      <section id="radar" class="card">
        <div class="bar">üõ∞ Radar & Satellite</div>
        <div id="radarHtml">Loading‚Ä¶</div>
      </section>

      <section id="lightning" class="card">
        <div class="bar">‚ö° Lightning Summary</div>
        <div id="lightningHtml">Loading‚Ä¶</div>
      </section>

      <section id="alerts" class="card">
        <div class="bar">‚ö†Ô∏è Alerts & Hazards</div>
        <div id="alertsHtml">Loading‚Ä¶</div>
      </section>

      <section id="health" class="card">
        <div class="bar">üå¨ Air & Health</div>
        <div id="airHtml">Loading‚Ä¶</div>
      </section>

      <section id="local" class="card">
        <div class="bar">üè´ Local Impacts</div>
        <div id="localHtml">Loading‚Ä¶</div>
      </section>

      <section id="rivers" class="card">
        <div class="bar">üåä Rivers & Streams</div>
        <div id="riversHtml">Loading‚Ä¶</div>
      </section>

      <section id="records" class="card">
        <div class="bar">üìä Climatology & Records</div>
        <div id="recordsHtml">Loading‚Ä¶</div>
      </section>

      <section id="astro" class="card">
        <div class="bar">üåå Astronomy & Skywatch</div>
        <div id="astroHtml">Loading‚Ä¶</div>
      </section>

      <section id="bottom" class="card">
        <div class="bar">‚úÖ Bottom Line</div>
        <div id="bottomHtml">Loading‚Ä¶</div>
      </section>
    </main>
  </div>

  <footer>
    <p><strong>Created by Matthew Carpenter</strong> ‚Äî 
      <a href="mailto:matthew@carpsemail.com" style="color:var(--link); text-decoration:underline">
        matthew@carpsemail.com
      </a>
    </p>
    <p><em>Data Sources:</em></p>
    <ul>
      <li>üåê NOAA / NWS ILN ‚Äî 7-Day Forecast, Alerts, AFD</li>
      <li>üå§Ô∏è Open-Meteo ‚Äî Backup Forecast & Astronomy</li>
      <li>ü´ß AirNow ‚Äî Current Air Quality Index</li>
      <li>üõ∞Ô∏è NWS / NOAA APIs ‚Äî Radar, Satellite, Rivers & Climatology</li>
      <li>‚ö° LightningMaps.org ‚Äî Real-time Lightning</li>
      <li>üöÄ NASA / Heavens Above ‚Äî ISS & Astronomy Events</li>
    </ul>
  </footer>

  <script>
    // Your deployed Apps Script Web App URL:
    const EXEC_URL = 'https://script.google.com/macros/s/AKfycbxEHXreFLXPTRzpnbU4Zzhz09iLXD9TyzxSyeTFfz6vzXLXzJdHcisLpHEHKH3U35K36w/exec';

    // THEME: load/store selection
    const THEME_KEY = 'rw-theme';
    function applyTheme(theme){
      document.body.classList.remove('theme-retro','theme-night','theme-contrast');
      if (theme === 'retro') document.body.classList.add('theme-retro');
      else if (theme === 'night') document.body.classList.add('theme-night');
      else if (theme === 'contrast') document.body.classList.add('theme-contrast');
      // default (NWS) uses base variables, no class needed
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'nws';
      const sel = document.getElementById('themeSelect');
      sel.value = saved;
      applyTheme(saved);
      sel.addEventListener('change', () => {
        const val = sel.value;
        localStorage.setItem(THEME_KEY, val);
        applyTheme(val);
      });
    }

    // Remove previous JSONP script tags to avoid stacking
    function removeOldJsonp_() {
      document.querySelectorAll('script[data-jsonp="1"]').forEach(s => s.remove());
    }

    function loadJSONP(force = false) {
      removeOldJsonp_();
      const s = document.createElement('script');
      s.setAttribute('data-jsonp','1');
      const ts = Date.now();
      s.src = `${EXEC_URL}?format=jsonp&callback=renderReport&force=${force?1:0}&_=${ts}`;
      s.defer = true;
      document.head.appendChild(s);
    }

    const btn = document.getElementById('refreshBtn');
    btn.addEventListener('click', () => {
      btn.disabled = true;
      btn.textContent = 'Refreshing‚Ä¶';
      loadJSONP(true);
      setTimeout(()=>{btn.disabled=false;btn.textContent='‚Üª Refresh';}, 6000);
    });

    function renderReport(report) {
      document.title = report.meta.runTitle || 'Ripley Weather ‚Ä¢ Dashboard';
      document.getElementById('runTitle').textContent = report.meta.runTitle || 'Ripley Weather';
      document.getElementById('runStamp').textContent = `${report.meta.runTime} ‚Ä¢ #${report.meta.totalToday}`;

      document.getElementById('quickHtml').innerHTML     = report.quick;
      document.getElementById('cardsHtml').innerHTML     = report.cards;
      document.getElementById('sevenHtml').innerHTML     = report.sevenDay;
      document.getElementById('plannerHtml').innerHTML   = report.hourly;
      document.getElementById('trendsHtml').innerHTML    = report.trends;
      document.getElementById('severeHtml').innerHTML    = report.severe;
      document.getElementById('radarHtml').innerHTML     = report.radar;
      document.getElementById('lightningHtml').innerHTML = report.lightning;
      document.getElementById('alertsHtml').innerHTML    = report.alerts;
      document.getElementById('airHtml').innerHTML       = report.air;
      document.getElementById('localHtml').innerHTML     = report.local;
      document.getElementById('riversHtml').innerHTML    = report.rivers;
      document.getElementById('recordsHtml').innerHTML   = report.records;
      document.getElementById('astroHtml').innerHTML     = report.astro;
      document.getElementById('bottomHtml').innerHTML    = report.bottom;

      const afd = document.getElementById('afdLink');
      if (afd && report.afdLink) afd.href = report.afdLink;

      btn.disabled = false;
      btn.textContent = '‚Üª Refresh';
    }

    // Initial theme + data
    initTheme();
    loadJSONP(false);
  </script>
</body>
</html>
